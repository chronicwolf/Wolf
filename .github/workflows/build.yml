name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip

      - name: Unzip project
        run: |
          set -e
          rm -rf _unzipped
          mkdir -p _unzipped
          unzip -q "ClientTrackerProject.zip" -d _unzipped
          ls -la _unzipped

      - name: Find project root
        run: |
          set -e
          echo "Searching for settings.gradle..."
          ROOT="$(dirname "$(find _unzipped -name settings.gradle -o -name settings.gradle.kts | head -n 1)")"
          if [ -z "$ROOT" ]; then
            echo "❌ Could not find settings.gradle(.kts) in zip"
            exit 1
          fi
          echo "✅ Root=$ROOT"
          echo "ROOT=$ROOT" >> $GITHUB_ENV

      - name: Build debug APK
        run: |
          set -e
          cd "$ROOT"
          chmod +x gradlew || true
          ./gradlew --no-daemon assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ env.ROOT }}/app/build/outputs/apk/debug/*.apk
